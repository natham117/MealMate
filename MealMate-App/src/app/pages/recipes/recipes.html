<div class="container">
  <h1>Hier findest du Rezepte!</h1>
  <p class="intro-text">
    St√∂ber durch das Archiv aller √∂ffentlichen Rezepte und lass dich inspirieren.
  </p>
  <p class="intro-text">
    Oder lege eigene Rezepte an. Du kannst dir aussuchen, ob du sie nur f√ºr dich behalten m√∂chtest oder sie mit der
    MealMate-Community teilen willst.
    Wir empfehlen Oma's Geheimrezept nicht f√ºr alle sichtbar zu machen!
  </p>

  <div class="snackbar"
    [ngClass]="{'active': showSnackbar, 'ok': snackbarType === 'ok', 'fail': snackbarType === 'fail'}">
    {{ snackbarMessage }}
  </div>

  <div class="header-bereich">
    <div class="search-bar">
      <span class="search-icon" (click)="triggerSearch()">üîç</span>
      <input type="text" placeholder="Rezept suchen..." [(ngModel)]="suchbegriff" (keyup.enter)="triggerSearch()" />
      <span class="clear-icon" (click)="clearSearch()">x</span>
    </div>

    <button class="hinzufuegen-btn" (click)="oeffneFormular()">+ Neues Rezept</button>
  </div>

  <p class="filter-titel">Filter:</p>
  <div class="filter-bereich">

    <label class="filter-checkbox">
      <input type="checkbox" [(ngModel)]="filter_vegetarisch">
      <span>Vegetarisch</span>
    </label>
    <label class="filter-checkbox">
      <input type="checkbox" [(ngModel)]="filter_vegan">
      <span>Vegan</span>
    </label>

    <!-- Filter nur f√ºr eingeloggte User (neue @if Syntax) -->
    @if (authService.isLoggedIn()) {
    <label class="filter-checkbox">
      <input type="checkbox" [(ngModel)]="filter_favoriten">
      <span>‚≠ê Favoriten</span>
    </label>
    <label class="filter-checkbox">
      <input type="checkbox" [(ngModel)]="filter_eigene_rezepte">
      <span>üë§ Eigene Rezepte</span>
    </label>
    }
  </div>

  <div class="rezept-liste">
    @for (rezept of gefilterte_rezepte; track rezept.id) {
    <div class="rezept-karte" (click)="zeigeDetails(rezept)">
      @if (rezept.bild) {
      <img class="rezept-bild" [src]="rezept.bild" [alt]="rezept.titel">
      } @else {
      <div class="rezept-bild"></div>
      }
      <!-- 
        <button
          class="pdf-btn klein"
          title="PDF herunterladen"
          (click)="ladePdf(rezept.id, rezept.titel, $event)">
          ‚¨áÔ∏è PDF
        </button> -->

      <div class="rezept-inhalt">
        <h2 class="rezept-titel">{{ rezept.titel }}</h2>
        <div class="rezept-info">
          <div class="info-item">
            <span>‚è±Ô∏è</span>
            <span>{{ rezept.zeit }}</span>
          </div>
          <div class="info-item">
            <span>üë•</span>
            <span>{{ rezept.portionen }}</span>
          </div>
        </div>
        <p class="rezept-beschreibung">
          {{ rezept.beschreibung }}
        </p>
        @if (rezept.vegetarisch || rezept.vegan) {
        <div class="rezept-eigenschaften">
          @if (rezept.vegetarisch) {
          <span class="eigenschaft-badge-klein">üå±</span>
          }
          @if (rezept.vegan) {
          <span class="eigenschaft-badge-klein">üåø</span>
          }
        </div>
        }
        <div class="rezept-zutaten">
          <h3>Zutaten:</h3>
          <ul>
            @for (zutat of rezept.zutaten; track $index) {
            <li>
              @if (zutat.menge && zutat.menge !== '' && zutat.menge !== '0' && zutat.menge !== 0) {
              <span>{{ zutat.menge }} {{ zutat.einheit }}</span>
              }
              {{ zutat.zutat }}
            </li>
            }
          </ul>
        </div>
      </div>
    </div>
    }

    @if (gefilterte_rezepte.length === 0) {
    <div class="keine-ergebnisse">
      <p>Keine Rezepte gefunden f√ºr "{{ suchbegriff }}"</p>
    </div>
    }
  </div>

  <!-- Modal f√ºr Detailansicht -->
  <div class="modal" [class.aktiv]="modal_aktiv">
    @if (ausgewaehltes_rezept) {
    <div class="modal-inhalt">
      <button class="schliessen-btn" (click)="schliesseModal()">√ó</button>

      <!-- Ansichtsmodus -->
      @if (!bearbeitungsmodus) {
      <div>
        @if (ausgewaehltes_rezept.bild) {
        <img class="detail-bild" [src]="ausgewaehltes_rezept.bild" [alt]="ausgewaehltes_rezept.titel">
        } @else {
        <div class="detail-bild"></div>
        }

        <div class="detail-inhalt">
          <div class="detail-header">
            <h2 class="detail-titel">{{ ausgewaehltes_rezept.titel }}</h2>
            <div class="detail-aktionen">
              <!-- Favorit-Button nur f√ºr eingeloggte User -->
              @if (authService.isLoggedIn()) {
              <button class="favorit-btn" [class.ist-favorit]="ausgewaehltes_rezept.istFavorit"
                (click)="toggleFavorit()">
                @if (!ausgewaehltes_rezept.istFavorit) {
                <span>‚òÜ Favorit</span>
                } @else {
                <span>‚òÖ Favorit</span>
                }
              </button>
              }
              <!-- Bearbeiten-Button nur f√ºr eigene Rezepte -->
              @if (authService.isLoggedIn() && authService.getUserId() === ausgewaehltes_rezept.userId) {
              <button class="bearbeiten-btn" (click)="starteBearbeitung()">‚úèÔ∏è</button>
              }
              <!-- Herunterladen-Button f√ºr PDF_Datei -->
              @if (authService.isLoggedIn()) {
              <button class="pdf-btn" [disabled]="pdfLaedt"
                (click)="ladePdf(ausgewaehltes_rezept.id, ausgewaehltes_rezept.titel)">
                @if (!pdfLaedt) { üìÑ PDF } @else { ‚Ä¶ l√§dt ‚Ä¶ }
              </button>
              }
              <!-- Button f√ºr Einkaufsliste -->
              @if (authService.isLoggedIn()) {
              <button class="einkaufsliste-btn" (click)="oeffneEinkaufslistenDialog()">
                üõí In Einkaufsliste
              </button>
              }
            </div>
          </div>

          <div class="detail-info">
            <div class="info-item">
              <span>‚è±Ô∏è</span>
              <span>{{ ausgewaehltes_rezept.zeit }}</span>
            </div>
            <div class="info-item">
              <span>üë•</span>
              <span>{{ ausgewaehltes_rezept.portionen }}</span>
            </div>
          </div>
          <p class="detail-beschreibung">{{ ausgewaehltes_rezept.beschreibung }}</p>

          <div class="detail-zutaten">
            <h3>Zutaten</h3>
            <ul>
              @for (zutat of ausgewaehltes_rezept.zutaten; track $index) {
              <li>
                @if (zutat.menge && zutat.menge !== '' && zutat.menge !== '0' && zutat.menge !== 0) {
                <span>{{ zutat.menge }} {{ zutat.einheit }}</span>
                }
                {{ zutat.zutat }}
              </li>
              }
            </ul>
          </div>

          @if (ausgewaehltes_rezept.anleitung) {
          <div class="detail-section">
            <h3>Zubereitung</h3>
            <p class="detail-anleitung">{{ ausgewaehltes_rezept.anleitung }}</p>
          </div>
          }

          @if (ausgewaehltes_rezept.vegetarisch || ausgewaehltes_rezept.vegan) {
          <div class="detail-eigenschaften">
            @if (ausgewaehltes_rezept.vegetarisch) {
            <span class="eigenschaft-badge">üå± Vegetarisch</span>
            }
            @if (ausgewaehltes_rezept.vegan) {
            <span class="eigenschaft-badge">üåø Vegan</span>
            }
          </div>
          }
        </div>
      </div>
      }

      <!-- Bearbeitungsmodus -->
      @if (bearbeitungsmodus && bearbeitetes_rezept) {
      <div class="detail-inhalt">
        <h2 class="detail-titel">Rezept bearbeiten</h2>

        <form (ngSubmit)="speichereBearbeitung()">
          <div class="form-gruppe">
            <label>Rezeptname *</label>
            <input type="text" [(ngModel)]="bearbeitetes_rezept.titel" name="titel" class="form-input" required>
          </div>

          <div class="form-gruppe">
            <label>Zubereitungszeit (in Minuten)</label>
            <input type="number" [(ngModel)]="temp_bearbeitung_zeit" name="zeit" class="form-input"
              placeholder="z.B. 30" min="0">
          </div>

          <div class="form-gruppe">
            <label>Portionen</label>
            <input type="number" [(ngModel)]="temp_bearbeitung_portionen" name="portionen" class="form-input"
              placeholder="z.B. 4" min="0">
          </div>

          <div class="form-gruppe">
            <label>Beschreibung</label>
            <textarea [(ngModel)]="bearbeitetes_rezept.beschreibung" name="beschreibung" class="form-textarea"
              rows="3"></textarea>
          </div>

          <div class="form-gruppe">
            <label>Zubereitung</label>
            <textarea [(ngModel)]="bearbeitetes_rezept.anleitung" name="anleitung" class="form-textarea" rows="5"
              placeholder="Schritt-f√ºr-Schritt Anleitung..."></textarea>
          </div>

          <div class="form-gruppe">
            <label>Bild-URL (optional)</label>
            <input type="text" [(ngModel)]="bearbeitetes_rezept.bild" name="bild" class="form-input"
              placeholder="https://...">
          </div>

          <div class="form-gruppe">
            <label>Eigenschaften</label>
            <div class="eigenschaften-checkboxen">
              <label class="filter-checkbox">
                <input type="checkbox" [(ngModel)]="bearbeitetes_rezept.vegetarisch" name="vegetarisch">
                <span>Vegetarisch</span>
              </label>
              <label class="filter-checkbox">
                <input type="checkbox" [(ngModel)]="bearbeitetes_rezept.vegan" name="vegan"
                  (change)="onBearbeitungVeganChange()">
                <span>Vegan</span>
              </label>
            </div>
          </div>

          <div class="form-gruppe">
            <label>Zutaten</label>
            <div class="zutaten-liste">
              @for (zutat of bearbeitetes_rezept.zutaten; track $index; let i = $index) {
              <div class="zutat-zeile">
                <input type="text" [(ngModel)]="bearbeitetes_rezept.zutaten[i].zutat" [name]="'bearbeitung_zutat' + i"
                  class="form-input zutat-name" placeholder="Zutat">
                <input type="text" [(ngModel)]="bearbeitetes_rezept.zutaten[i].menge" [name]="'bearbeitung_menge' + i"
                  class="form-input zutat-menge" placeholder="Menge">
                <input type="text" [(ngModel)]="bearbeitetes_rezept.zutaten[i].einheit"
                  [name]="'bearbeitung_einheit' + i" class="form-input zutat-einheit" placeholder="Einheit">
                @if (bearbeitetes_rezept.zutaten.length > 1) {
                <button type="button" class="entfernen-btn" (click)="entferneBearbeitungsZutat(i)">√ó</button>
                }
              </div>
              }
            </div>
            <button type="button" class="zutat-hinzufuegen-btn" (click)="fuegeBearbeitungsZutatHinzu()">+ Zutat
              hinzuf√ºgen</button>
          </div>

          <div class="form-aktionen">
            <button type="button" class="abbrechen-btn" (click)="abbrechenBearbeitung()">Abbrechen</button>
            <button type="submit" class="speichern-btn">Speichern</button>
          </div>
        </form>
      </div>
      }
    </div>
    }
  </div>

  <!-- Modal f√ºr neues Rezept -->
  <div class="modal" [class.aktiv]="formular_aktiv">
    <div class="modal-inhalt">
      <button class="schliessen-btn" (click)="schliesseFormular()">√ó</button>

      <div class="detail-inhalt">
        <h2 class="detail-titel">Neues Rezept</h2>

        <form (ngSubmit)="speichereRezept()">
          <div class="form-gruppe">
            <label>Rezeptname *</label>
            <input type="text" [(ngModel)]="neues_rezept.titel" name="titel" class="form-input" required>
          </div>

          <div class="form-gruppe">
            <label>Zubereitungszeit (in Minuten)</label>
            <input type="number" [(ngModel)]="temp_zeit" name="zeit" class="form-input" placeholder="z.B. 30" min="0">
          </div>

          <div class="form-gruppe">
            <label>Portionen</label>
            <input type="number" [(ngModel)]="temp_portionen" name="portionen" class="form-input" placeholder="z.B. 4"
              min="0">
          </div>

          <div class="form-gruppe">
            <label>Beschreibung</label>
            <textarea [(ngModel)]="neues_rezept.beschreibung" name="beschreibung" class="form-textarea"
              rows="3"></textarea>
          </div>

          <div class="form-gruppe">
            <label>Zubereitung</label>
            <textarea [(ngModel)]="neues_rezept.anleitung" name="anleitung" class="form-textarea" rows="5"
              placeholder="Schritt-f√ºr-Schritt Anleitung..."></textarea>
          </div>

          <div class="form-gruppe">
            <label>Bild-URL (optional)</label>
            <input type="text" [(ngModel)]="neues_rezept.bild" name="bild" class="form-input" placeholder="https://...">
          </div>

          <div class="form-gruppe">
            <label>Eigenschaften</label>
            <div class="eigenschaften-checkboxen">
              <label class="filter-checkbox">
                <input type="checkbox" [(ngModel)]="neues_rezept.vegetarisch" name="vegetarisch">
                <span>Vegetarisch</span>
              </label>
              <label class="filter-checkbox">
                <input type="checkbox" [(ngModel)]="neues_rezept.vegan" name="vegan" (change)="onVeganChange()">
                <span>Vegan</span>
              </label>
            </div>
          </div>

          <div class="form-gruppe">
            <label>Zutaten</label>
            <div class="zutaten-liste">
              @for (zutat of neues_rezept.zutaten; track $index; let i = $index) {
              <div class="zutat-zeile">
                <input type="text" [(ngModel)]="neues_rezept.zutaten[i].zutat" [name]="'zutat' + i"
                  class="form-input zutat-name" placeholder="Zutat">
                <input type="text" [(ngModel)]="neues_rezept.zutaten[i].menge" [name]="'menge' + i"
                  class="form-input zutat-menge" placeholder="Menge">
                <input type="text" [(ngModel)]="neues_rezept.zutaten[i].einheit" [name]="'einheit' + i"
                  class="form-input zutat-einheit" placeholder="Einheit">
                @if (neues_rezept.zutaten.length > 1) {
                <button type="button" class="entfernen-btn" (click)="entferneZutat(i)">√ó</button>
                }
              </div>
              }
            </div>
            <button type="button" class="zutat-hinzufuegen-btn" (click)="fuegeZutatHinzu()">+ Zutat hinzuf√ºgen</button>
          </div>

          <div class="form-aktionen">
            <button type="button" class="abbrechen-btn" (click)="schliesseFormular()">Abbrechen</button>
            <button type="submit" class="speichern-btn">Speichern</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal f√ºr Einkaufslisten-Name -->
  <div class="modal" [class.aktiv]="einkaufslisten_dialog_aktiv">
    <div class="modal-inhalt einkaufslisten-dialog">
      <button class="schliessen-btn" (click)="schliesseEinkaufslistenDialog()">√ó</button>

      <div class="detail-inhalt">
        <h2 class="detail-titel">In Einkaufsliste √ºbernehmen</h2>
        <p class="dialog-beschreibung">Gib einen Namen f√ºr die neue Einkaufsliste ein:</p>

        <form (ngSubmit)="erstelleEinkaufsliste()">
          <div class="form-gruppe">
            <label>Name der Einkaufsliste *</label>
            <input type="text" [(ngModel)]="einkaufslisten_name" name="einkaufslisten_name" class="form-input"
              placeholder="z.B. Einkauf f√ºr Spaghetti Carbonara" required autofocus>
          </div>

          <div class="form-aktionen">
            <button type="button" class="abbrechen-btn" (click)="schliesseEinkaufslistenDialog()">Abbrechen</button>
            <button type="submit" class="speichern-btn" [disabled]="einkaufslisten_erstellen_laeuft">
              @if (!einkaufslisten_erstellen_laeuft) { Erstellen } @else { ‚Ä¶ wird erstellt ‚Ä¶ }
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>